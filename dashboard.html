<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BrahmaTech Bot | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
<style>
    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        display: flex;
        background: #f5f6fa;
        color: #333;
    }
    .sidebar {
        width: 220px;
        background: #ff4da6;
        color: white;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: fixed;
        left: 0;
        top: 0;
        padding-top: 20px;
    }
    .sidebar h2 {
        text-align: center;
        margin-bottom: 30px;
    }
    .sidebar a {
        padding: 14px 20px;
        color: white;
        text-decoration: none;
        display: block;
        transition: background 0.3s;
    }
    .sidebar a:hover, .sidebar a.active {
        background: rgba(255, 255, 255, 0.2);
    }
    .main {
        margin-left: 220px;
        padding: 20px;
        flex: 1;
    }
    h1 {
        margin-top: 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card img {
        width: 40px;
        margin-bottom: 10px;
    }
    .card h3 {
        margin: 0;
        font-size: 1.4em;
    }
    .card p {
        color: gray;
        margin: 5px 0 0;
    }
    .badge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
    }
    .badge {
        background: white;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .badge img {
        width: 60px;
    }
    .badge span {
        display: block;
        margin-top: 5px;
        font-size: 0.9em;
    }
    .leaderboard {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .leaderboard table {
        width: 100%;
        border-collapse: collapse;
    }
    .leaderboard th, .leaderboard td {
        padding: 8px;
        text-align: left;
    }
    .leaderboard tr:nth-child(even) {
        background: #f9f9f9;
    }
    .lb-avatar {
        border-radius: 50%;
        width: 32px;
        vertical-align: middle;
        margin-right: 8px;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h2>Dashboard</h2>
    <a href="#" class="active" onclick="showSection('stats')">üìä Stats</a>
    <a href="#" onclick="showSection('badges')">üèÖ Badges</a>
    <a href="#" onclick="showSection('charts')">üìà Charts</a>
    <a href="#" onclick="showSection('leaderboards')">üèÜ Leaderboards</a>
    <a href="servers.html">‚¨Ö Back</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<!-- Main content -->
<div class="main">
    <h1 id="guildName">Loading...</h1>

    <!-- Stats Section -->
    <div id="stats" class="section">
        <div class="stats-grid">
            <div class="card"><img src="assets/icons/xp.png"><h3 id="xp">0</h3><p>XP</p></div>
            <div class="card"><img src="assets/icons/vc.png"><h3 id="vcTime">0h</h3><p>VC Time</p></div>
            <div class="card"><img src="assets/icons/level.png"><h3 id="level">0</h3><p>Level</p></div>
            <div class="card"><img src="assets/icons/streak.png"><h3 id="streak">0</h3><p>Streak</p></div>
            <div class="card"><img src="assets/icons/coins.png"><h3 id="coins">0</h3><p>Coins</p></div>
        </div>
    </div>

    <!-- Badges Section -->
    <div id="badges" class="section" style="display:none;">
        <div class="badge-grid" id="badgeGrid">
            Loading badges...
        </div>
    </div>

    <!-- Charts Section -->
    <div id="charts" class="section" style="display:none;">
        <div class="chart-container">
            <h3>XP Growth</h3>
            <canvas id="xpChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>VC Time Growth</h3>
            <canvas id="vcChart"></canvas>
        </div>
    </div>

    <!-- Leaderboards Section -->
    <div id="leaderboards" class="section" style="display:none;">
        <div class="leaderboard">
            <h3>VC Leaderboard</h3>
            <table id="vcLeaderboard">
                <tr><th>#</th><th>User</th><th>Time</th></tr>
            </table>
        </div>
        <br>
        <div class="leaderboard">
            <h3>Messages Leaderboard</h3>
            <table id="msgLeaderboard">
                <tr><th>#</th><th>User</th><th>Messages</th></tr>
            </table>
        </div>
    </div>
</div>

<script>
function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    event.target.classList.add('active');
}

function logout() {
    localStorage.clear();
    window.location.href = "index.html";
}

// === Handle OAuth Redirect ===
(function () {
    const params = new URLSearchParams(window.location.search);
    const encodedData = params.get("data");

    if (encodedData) {
        try {
            const decoded = JSON.parse(atob(encodedData));
            localStorage.setItem("accessToken", decoded.token);
            localStorage.setItem("tokenType", decoded.tokenType);
            localStorage.setItem("currentUser", JSON.stringify(decoded.user));
            localStorage.setItem("mutualServers", JSON.stringify(decoded.servers));
            console.log("Stored OAuth login data:", decoded);
            window.history.replaceState({}, document.title, "dashboard.html");
        } catch (err) {
            console.error("Invalid OAuth data:", err);
            alert("Login failed, please try again.");
            window.location.href = "index.html";
        }
    }
})();

// === Auth & Guild Info ===
const token = localStorage.getItem("accessToken");
if (!token) {
    alert("No access token found. Please log in again.");
    window.location.href = "index.html";
}

const guild = JSON.parse(localStorage.getItem("selectedGuild"));
document.getElementById("guildName").textContent = guild ? guild.name : "Unknown Server";

const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) {
    alert("No user info found. Please log in again.");
    window.location.href = "index.html";
}

// === Fetch Stats ===
fetch(`https://brahmatech-backend.vercel.app/api/stats?action=user-stats&guildId=${guild.id}&userId=${currentUser.id}`, {
    headers: { Authorization: `Bearer ${token}` }
})
.then(res => res.json())
.then(data => {
    document.getElementById("xp").textContent = data.xp || 0;
    document.getElementById("vcTime").textContent = (data.vcTime || 0) + "h";
    document.getElementById("level").textContent = data.level || 0;
    document.getElementById("streak").textContent = data.streak || 0;
    document.getElementById("coins").textContent = data.coins || 0;

    const badgeGrid = document.getElementById("badgeGrid");
    badgeGrid.innerHTML = "";
    if (data.badges && data.badges.length) {
        data.badges.forEach(b => {
            const div = document.createElement("div");
            div.className = "badge";
            div.innerHTML = `<img src="assets/badges/${b}.png"><span>${b}</span>`;
            badgeGrid.appendChild(div);
        });
    } else {
        badgeGrid.textContent = "No badges earned yet.";
    }

    if (data.xpHistory && data.vcHistory) {
        new Chart(document.getElementById("xpChart"), {
            type: 'line',
            data: {
                labels: Object.keys(data.xpHistory),
                datasets: [{
                    label: 'XP',
                    data: Object.values(data.xpHistory),
                    borderColor: '#ff4da6',
                    fill: false
                }]
            }
        });
        new Chart(document.getElementById("vcChart"), {
            type: 'line',
            data: {
                labels: Object.keys(data.vcHistory),
                datasets: [{
                    label: 'VC Hours',
                    data: Object.values(data.vcHistory),
                    borderColor: '#4da6ff',
                    fill: false
                }]
            }
        });
    }
})
.catch(err => console.error("Stats fetch error:", err));

function fillLB(tableId, data) {
    const table = document.getElementById(tableId);
    let pos = 1;
    data.forEach(user => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${pos}</td>
            <td><img src="${user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="lb-avatar">${user.username}</td>
            <td>${user.value}</td>`;
        table.appendChild(row);
        pos++;
    });
}

fetch(`https://brahmatech-backend.vercel.app/api/stats?action=leaderboard&guildId=${guild.id}&type=vc`, {
    headers: { Authorization: `Bearer ${token}` }
})
.then(res => res.json())
.then(vcLB => fillLB("vcLeaderboard", vcLB))
.catch(err => console.error("VC leaderboard error:", err));

fetch(`https://brahmatech-backend.vercel.app/api/stats?action=leaderboard&guildId=${guild.id}&type=msg`, {
    headers: { Authorization: `Bearer ${token}` }
})
.then(res => res.json())
.then(msgLB => fillLB("msgLeaderboard", msgLB))
.catch(err => console.error("Message leaderboard error:", err));
</script>
</body>
</html>
